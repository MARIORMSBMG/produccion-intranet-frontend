
<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title>Formulario Habilitado</title>
  <style>
    body { font-family: Arial; background: #f4f4f4; padding: 20px; }
    table { width: 100%; border-collapse: collapse; margin-top: 20px; }
    th, td { border: 1px solid #ccc; padding: 8px; text-align: center; }
    th { background-color: #007BFF; color: white; }
    input { width: 100%; padding: 4px; }
    #cerrarSesion, #guardarBtn { margin: 10px 4px; padding: 10px 15px; }
    .btn { border: none; cursor: pointer; color: white; font-weight: bold; }
    #guardarBtn { background-color: #007BFF; }
    #cerrarSesion { background-color: #dc3545; }
  </style>
</head>
<body>
  <h2>Formulario Habilitado</h2>
  <label>Nómina: <input type="text" id="nomina" /></label><br />
  <label>Nombre: <input type="text" id="nombre" readonly /></label><br />
  <label>Área: <input type="text" id="area" value="Habilitado" readonly /></label><br />
  <label>Fecha: <input type="date" id="fecha" /></label><br />

  <table id="tabla">
    <thead>
      <tr>
        <th>Hora</th>
        <th>Proyecto</th>
        <th>Código</th>
        <th>Estándar</th>
        <th>Piezas</th>
        <th>Interferencia (min)</th>
        <th>Motivo</th>
        <th>Eficiencia (%)</th>
      </tr>
    </thead>
    <tbody></tbody>
    <tfoot>
      <tr>
        <td colspan="7"><strong>Promedio de Eficiencia</strong></td>
        <td id="promedio">0%</td>
      </tr>
    </tfoot>
  </table>

  <button class="btn" id="guardarBtn">Guardar</button>
  <button class="btn" id="cerrarSesion">Cerrar sesión</button>

  <script>
    const API_URL = 'https://produccion-intranet-backend.onrender.com';
    const horas = [
      "07:00-08:00","08:00-09:00","09:00-10:00","10:00-11:00","11:00-12:00",
      "12:00-13:00","13:00-14:00","14:00-15:00","15:00-16:00",
      "16:00-17:00","17:00-18:00","18:00-19:00"
    ];
    let estandares = [];

    window.onload = async () => {
      const nomina = localStorage.getItem('nomina');
      const token = localStorage.getItem('token');
      document.getElementById('nomina').value = nomina;

      // Auto completar nombre
      fetch(`${API_URL}/nombre/${nomina}`)
        .then(res => res.json())
        .then(data => document.getElementById('nombre').value = data.nombre);

      // Obtener estándares
      const res = await fetch(`${API_URL}/api/estandares?area=Habilitado`);
      estandares = await res.json();

      // Generar filas por hora
      const tbody = document.querySelector('#tabla tbody');
      horas.forEach(hora => {
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td>${hora}</td>
          <td><input class="proyecto" readonly /></td>
          <td><input class="codigo" /></td>
          <td><input class="estandar" readonly /></td>
          <td><input class="piezas" type="number" /></td>
          <td><input class="interferencia" type="number" /></td>
          <td><input class="motivo" /></td>
          <td class="eficiencia">0%</td>
        `;
        tbody.appendChild(tr);
      });

      document.querySelectorAll('.codigo').forEach(input => {
        input.addEventListener('input', e => {
          const row = e.target.closest('tr');
          const val = e.target.value.trim();
          const match = estandares.find(e => e.codigo === val);
          row.querySelector('.estandar').value = match ? match.estandar : '';
          row.querySelector('.proyecto').value = match ? match.proyecto : '';
        });
      });

      document.querySelectorAll('.piezas, .interferencia').forEach(input => {
        input.addEventListener('input', calcularEficiencia);
      });
    };

    function calcularEficiencia() {
      let total = 0, count = 0;
      document.querySelectorAll('#tabla tbody tr').forEach(tr => {
        const piezas = parseFloat(tr.querySelector('.piezas').value) || 0;
        const estandar = parseFloat(tr.querySelector('.estandar').value) || 0;
        const interferencia = parseFloat(tr.querySelector('.interferencia').value) || 0;
        const tiempo = 60 - interferencia;
        let eficiencia = 0;
        if (estandar > 0 && tiempo > 0) eficiencia = (piezas / (estandar * (tiempo / 60))) * 100;
        tr.querySelector('.eficiencia').textContent = `${eficiencia.toFixed(0)}%`;
        if (eficiencia > 0) {
          total += eficiencia;
          count++;
        }
      });
      document.getElementById('promedio').textContent = count ? `${(total / count).toFixed(0)}%` : '0%';
    }

    document.getElementById('cerrarSesion').onclick = () => {
      localStorage.clear();
      window.location.href = '/index.html';
    };
  </script>
</body>
</html>
