<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Boomerang RMS - Formulario Producción</title>
  <link rel="stylesheet" href="styles.css" />
  <style>
    table { width: 100%; border-collapse: collapse; }
    th, td { padding: 8px; border: 1px solid #ccc; text-align: center; }
    th { background-color: #f4f4f4; }
    .encabezado { display: flex; justify-content: space-between; align-items: center; margin-bottom: 1em; }
  </style>
</head>
<body>
  <div class="container">
    <h1>Boomerang RMS - Registro de Producción</h1>
    <div class="encabezado">
      <div>
        <p><strong>Nombre:</strong> <span id="nombreUsuario">Cargando...</span></p>
        <p><strong>Nómina:</strong> <span id="nominaUsuario">Cargando...</span></p>
      </div>
      <div>
        <label for="turno">Turno:</label>
        <select id="turno">
          <option value="Mixto">Mixto</option>
          <option value="4to">4to</option>
          <option value="3ro">3ro</option>
          <option value="Extra">Extra</option>
        </select>
      </div>
    </div>

    <table id="tabla-produccion">
      <thead>
        <tr>
          <th>Hora</th>
          <th>Código 1</th><th>Proyecto 1</th><th>Estándar 1</th><th>Piezas 1</th>
          <th>Código 2</th><th>Proyecto 2</th><th>Estándar 2</th><th>Piezas 2</th>
          <th>Interferencia (min)</th><th>Motivo</th><th>Tipo</th>
          <th>Eficiencia</th>
        </tr>
      </thead>
      <tbody id="cuerpo-tabla"></tbody>
    </table>

    <div style="margin-top: 1em;">
      <label for="maquina">Máquina:</label>
      <input type="text" id="maquina" />
      <p><strong>Eficiencia Total:</strong> <span id="eficienciaTotal">0%</span></p>
      <button id="guardarBtn">Guardar</button>
      <button onclick="cerrarSesion()">Cerrar Sesión</button>
    </div>
  </div>

  <script>
    const cuerpoTabla = document.getElementById('cuerpo-tabla');
    const horas = Array.from({ length: 13 }, (_, i) => `${7 + i}:00`);

    const nomina = localStorage.getItem('nomina');
    const nombre = localStorage.getItem('nombre');
    document.getElementById('nominaUsuario').textContent = nomina || 'Sin información';
    document.getElementById('nombreUsuario').textContent = nombre || 'Sin información';

    horas.forEach(hora => {
      const row = document.createElement('tr');
      row.innerHTML = `
        <td>${hora}</td>
        <td><input class="codigo1" /></td>
        <td><input class="proyecto1" readonly /></td>
        <td><input class="estandar1" readonly /></td>
        <td><input type="number" class="piezas1" /></td>

        <td><input class="codigo2" /></td>
        <td><input class="proyecto2" readonly /></td>
        <td><input class="estandar2" readonly /></td>
        <td><input type="number" class="piezas2" /></td>

        <td><input type="number" class="interferencia" /></td>
        <td><input class="motivo" /></td>
        <td>
          <select class="tipo">
            <option value="evitable">Evitable</option>
            <option value="inevitable">Inevitable</option>
          </select>
        </td>

        <td><span class="eficiencia">0%</span></td>
      `;
      cuerpoTabla.appendChild(row);
    });

    function cerrarSesion() {
      localStorage.clear();
      window.location.href = 'index.html';
    }

    async function autocompletarCodigo(input, proyectoEl, estandarEl) {
      const codigo = input.value.trim();
      if (!codigo) return;
      try {
        const res = await fetch(`/estandares?codigo=${codigo}`);
        const data = await res.json();
        if (data.proyecto && data.estandar) {
          proyectoEl.value = data.proyecto;
          estandarEl.value = data.estandar;
        }
      } catch (err) {
        console.error('Error al obtener estándar:', err);
      }
    }

    document.getElementById('guardarBtn').addEventListener('click', async () => {
      const turno = document.getElementById('turno').value;
      const maquina = document.getElementById('maquina').value;
      const filas = Array.from(document.querySelectorAll('#cuerpo-tabla tr'));
      const produccion = filas.map((tr, i) => {
        const hora = horas[i];
        return {
          hora,
          codigo1: tr.querySelector('.codigo1').value,
          proyecto1: tr.querySelector('.proyecto1').value,
          estandar1: tr.querySelector('.estandar1').value,
          piezas1: parseInt(tr.querySelector('.piezas1').value || '0'),

          codigo2: tr.querySelector('.codigo2').value,
          proyecto2: tr.querySelector('.proyecto2').value,
          estandar2: tr.querySelector('.estandar2').value,
          piezas2: parseInt(tr.querySelector('.piezas2').value || '0'),

          interferencia: parseInt(tr.querySelector('.interferencia').value || '0'),
          motivo: tr.querySelector('.motivo').value,
          tipo: tr.querySelector('.tipo').value
        };
      });

      try {
        const res = await fetch('/registro', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ nomina, nombre, turno, maquina, produccion })
        });

        const data = await res.json();
        if (res.ok) {
          alert('Registro guardado correctamente');
        } else {
          alert('Error al guardar: ' + data.error);
        }
      } catch (err) {
        alert('Error de conexión con el servidor');
      }
    });

    document.querySelectorAll('.codigo1').forEach(input => {
      input.addEventListener('blur', () => {
        const row = input.closest('tr');
        autocompletarCodigo(input, row.querySelector('.proyecto1'), row.querySelector('.estandar1'));
      });
    });

    document.querySelectorAll('.codigo2').forEach(input => {
      input.addEventListener('blur', () => {
        const row = input.closest('tr');
        autocompletarCodigo(input, row.querySelector('.proyecto2'), row.querySelector('.estandar2'));
      });
    });
  </script>
</body>
</html>
