<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Formulario de Producción</title>
  <style>
    body { font-family: Arial; padding: 20px; }
    table { border-collapse: collapse; width: 100%; margin-top: 20px; }
    th, td { border: 1px solid #ccc; padding: 8px; text-align: center; }
    select[multiple] { height: 60px; }
    input[type="number"] { width: 70px; }
  </style>
</head>
<body>
  <h2>Formulario de Producción</h2>
  <form id="produccionForm">
    <label>Nómina: <input type="text" name="nomina" required></label><br>
    <label>Nombre: <input type="text" name="nombre" required></label><br>
    <label>Área:
      <select name="area" required>
        <option value="">-- Selecciona un área --</option>
        <option>Estampado</option>
        <option>Soldadura</option>
        <option>Troqueles</option>
        <option>Ensamble</option>
        <option>Pintura</option>
        <option>Corte</option>
        <option>Doblez</option>
        <option>Mantenimiento</option>
        <option>Calidad</option>
        <option>Logística</option>
        <option>Ingeniería</option>
        <option>Almacén</option>
        <option>Recubrimiento</option>
        <option>Administración</option>
      </select>
    </label><br>
    <label>Fecha: <input type="date" name="fecha" required value="2025-06-05"></label>

    <table id="tablaHoras">
      <thead>
        <tr>
          <th>Hora</th><th>Código</th><th>Estándar</th><th>Piezas</th>
          <th>Interferencias</th><th>Tiempo (min)</th><th>Eficiencia (%)</th>
        </tr>
      </thead>
      <tbody>
        <!-- Filas por hora -->
      </tbody>
    </table>
    <button type="submit">Guardar</button>
  </form>

  <script>
    const horas = [...Array(13).keys()].map(i => (7 + i) + ":00");
    const interferencias = ["Liberación por calidad", "Falta de materiales", "Cambio de herramienta", "Ajuste de máquina", "Mantenimiento", "Reunión", "Capacitación"];
    const codigos = {
      "HB8224-1": 200,
      "TR9832-2": 180,
      "FL2215-X": 150
    };

    const tbody = document.querySelector("#tablaHoras tbody");
    horas.forEach(hora => {
      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td>${hora}</td>
        <td><input name="codigo" list="codigoList" onchange="setEstandar(this)" required></td>
        <td><input name="estandar" readonly></td>
        <td><input type="number" name="piezas" min="0" required></td>
        <td><select name="interferencias" multiple>${interferencias.map(i => `<option>${i}</option>`).join('')}</select></td>
        <td><input type="number" name="tiempo" min="0" max="60" required></td>
        <td><input name="eficiencia" readonly></td>`;
      tbody.appendChild(tr);
    });

    function setEstandar(input) {
      const estandar = codigos[input.value] || 0;
      input.parentElement.nextElementSibling.firstElementChild.value = estandar;
    }

    document.getElementById("produccionForm").addEventListener("submit", async function(e) {
      e.preventDefault();
      const form = e.target;
      const data = {
        nomina: form.nomina.value,
        nombre: form.nombre.value,
        area: form.area.value,
        fecha: form.fecha.value,
        registros: []
      };

      [...tbody.rows].forEach(row => {
        const cells = row.querySelectorAll("td");
        data.registros.push({
          hora: cells[0].textContent,
          codigo: cells[1].querySelector("input").value,
          estandar: parseInt(cells[2].querySelector("input").value || 0),
          piezas: parseInt(cells[3].querySelector("input").value || 0),
          interferencias: [...cells[4].querySelector("select").selectedOptions].map(o => o.value),
          tiempo: parseInt(cells[5].querySelector("input").value || 0),
          eficiencia: (parseInt(cells[2].querySelector("input").value) > 0)
            ? ((parseInt(cells[3].querySelector("input").value) / parseInt(cells[2].querySelector("input").value)) * 100).toFixed(2)
            : 0
        });
      });

      const res = await fetch("/registro", {
        method: "POST",
        headers: {"Content-Type": "application/json"},
        body: JSON.stringify(data)
      });

      if (res.ok) alert("Registro guardado correctamente");
      else alert("Error al guardar");
    });
  </script>
</body>
</html>
